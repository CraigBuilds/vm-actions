name: 'Provision VM'
description: 'Initializes, validates and builds a VM using Packer with the parameterized template'
inputs:
  input_image:
    description: 'URL or path to the input base image (cloud image or existing QCOW2)'
    required: true
  output_directory:
    description: 'Directory where the build output will be stored'
    required: true
  output_name:
    description: 'Name of the output VM file'
    required: true
  input_provision_script:
    description: 'Path to the provisioning script to run'
    required: true
  build_name:
    description: 'Descriptive name for this build (displayed in Packer logs and build metadata, does not affect output files)'
    required: true
  disk_compression:
    description: 'Enable qcow2 internal compression during Packer compaction (may slow builds)'
    required: false
    default: 'false'
  username:
    description: 'Username for SSH access and cloud-init'
    required: false
    default: 'packer'
  password:
    description: 'Password for the user (use plain text or a hash from mkpasswd/openssl, e.g., mkpasswd -m sha-512)'
    required: false
    default: ''
  hostname:
    description: 'Hostname for the VM'
    required: false
    default: 'vm-host'
  ssh_public_key:
    description: 'SSH public key for authentication'
    required: false
    default: ''
  ssh_private_key_file:
    description: 'Path to SSH private key file for Packer to connect'
    required: false
    default: 'Packer/keys/packer_ed25519'

runs:
  using: 'composite'
  steps:
    - name: Initialize Packer template
      shell: bash
      run: packer init ${{ github.action_path }}/../template.pkr.hcl

    - name: Validate Packer template
      shell: bash
      run: |
        packer validate \
          -var "input_image=${{ inputs.input_image }}" \
          -var "output_directory=${{ inputs.output_directory }}" \
          -var "output_name=${{ inputs.output_name }}" \
          -var "input_provision_script=${{ inputs.input_provision_script }}" \
          -var "build_name=${{ inputs.build_name }}" \
          -var "disk_compression=${{ inputs.disk_compression }}" \
          -var "username=${{ inputs.username }}" \
          -var "password=${{ inputs.password }}" \
          -var "hostname=${{ inputs.hostname }}" \
          -var "ssh_public_key=${{ inputs.ssh_public_key }}" \
          -var "ssh_private_key_file=${{ inputs.ssh_private_key_file }}" \
          ${{ github.action_path }}/../template.pkr.hcl

    - name: Build VM with Packer
      shell: bash
      run: |
        packer build \
          -var "input_image=${{ inputs.input_image }}" \
          -var "output_directory=${{ inputs.output_directory }}" \
          -var "output_name=${{ inputs.output_name }}" \
          -var "input_provision_script=${{ inputs.input_provision_script }}" \
          -var "build_name=${{ inputs.build_name }}" \
          -var "disk_compression=${{ inputs.disk_compression }}" \
          -var "username=${{ inputs.username }}" \
          -var "password=${{ inputs.password }}" \
          -var "hostname=${{ inputs.hostname }}" \
          -var "ssh_public_key=${{ inputs.ssh_public_key }}" \
          -var "ssh_private_key_file=${{ inputs.ssh_private_key_file }}" \
          ${{ github.action_path }}/../template.pkr.hcl